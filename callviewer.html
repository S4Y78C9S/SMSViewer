<!doctype html>
<html lang='en'>
<head>
    <meta charset='utf-8'>
    <title>Call Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- jQuery to help make some magic happen -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.14.1/jquery-ui.min.js"></script>

    <!-- Twitter Bootstrap to make it pretty -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>

    <!-- Small UI tweaks -->
    <link rel="stylesheet" type="text/css" href="style.css">

</head>
<body>
<script type="text/javascript">

    function handleFileSelect(evt) {
        var file = evt.target.files[0];
        fr = new FileReader();
        fr.onload = receivedText;
        fr.readAsText(file);
    }       
    function sent_count(arr) {
        var result = 0;
        for ( const elem of arr) {
            if ( elem.type == 2 ) result++;
        }
        return result;
    }
    function received_count(arr) {
        var result = 0;
        for ( const elem of arr) {
            if ( elem.type == 1 ) result++;
        }
        return result;
    }
    function receivedText() { 
        var docContents = new Array();
        var text = fr.result.replace('&#5', '\&\#5');
        $xml = $( $.parseXML( text ) );
        $xml.find("call").each(function(){
            var var_name = $(this).attr("contact_name");
            docContents.push(
                { 
                    name: var_name,
                    readable_date: $(this).attr("readable_date"),
                    number: $(this).attr("number"),
                    date: $(this).attr("date"),
                    duration: $(this).attr("duration"),
                    type: parseInt($(this).attr("type"))
                }                   
            );
        });
        
        // 新しいものを先頭にする
        docContents = docContents.reverse();
        
        // Form the group
        var html = '<h3>Text Messages</h3>';
        


        // テーブル
        html += '<table>';
        html += '<thread>';
        html += '<tr>';
        html += '<th>date</th>';
        html += '<th>name</th>';
        html += '<th>number</th>';
        html += '<th>duration</th>';
        html += '<th>type</th>';
        html += '</tr>';
        html += '</thread>';
        html += '<tbody>';

        $.each(docContents, function(callIndex, callObject){
            switch ( callObject.type ) {
            case 1:
                type_text = "📞向こうから掛かってきた";
                break;
            case 2:
                type_text = "➡こちらから掛けた";
                break;
            case 3:
                type_text = "⛔ブロック中";
                break;
            case 5:
                type_text = "向こうから掛かってきたが出なかった";
                break;
            case 6:
                type_text = "😑迷惑電話";
                break;
            default:
                type_text = callObject.type;
            }
            html += '<tr>';
            html += '<td>' + callObject.readable_date + '</td>';
            html += '<td>' + callObject.name + '</td>';
            html += '<td>' + callObject.number + '</td>';
            html += '<td>' + callObject.duration + '</td>';
            html += '<td>' + type_text + '</td>';
            html += '</tr>';


            html += '</tbody>';
        });

        html += '</table>';
        // Finish the group
        $("#content").html(html);   
        
    }

    $(document).ready(function(){
        $("#xml-file").change(handleFileSelect);
    });
</script>
<input type="file" id="xml-file" name="files" />
<div id="content">
    
</div>
</body>
</html>
