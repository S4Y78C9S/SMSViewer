<!doctype html>
<html lang='en'>
<head>
    <meta charset='utf-8'>
    <title>XML Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- jQuery to help make some magic happen -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <!-- Twitter Bootstrap to make it pretty -->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <!-- Small UI tweaks -->
    <link rel="stylesheet" type="text/css" href="style.css">

</head>
<body>
<script type="text/javascript">

    function handleFileSelect(evt) {
        var file = evt.target.files[0];
        fr = new FileReader();
        fr.onload = receivedText;
        fr.readAsText(file);
    }       
console.log("debug1<br/>\n");
    function sent_count(arr) {
        var result = 0;
        for ( const elem of arr) {
            if ( elem.type == 2 ) result++;
        }
        return result;
    }
console.log("debug2<br/>\n");
    function received_count(arr) {
        var result = 0;
        for ( const elem of arr) {
            if ( elem.type == 1 ) result++;
        }
        return result;
    }
console.log("debug3<br/>\n");
    function receivedText() { 
        var docContents = new Array();
        var text = fr.result.replace('&#5', '\&\#5');
        //text = text.replace("&#10;","\n");
        //text = text.replace("&#10;","KAI");
        //text = text.replace("&#13;","\n");
        $xml = $( $.parseXML( text ) );
        $xml.find("sms").each(function(){
            var var_name = $(this).attr("contact_name");
            if(!var_name || var_name == "(Unknown)") var_name = $(this).attr("address").replace('+1', '');
            var temp = $.grep(docContents, function (e) { 
                return e.name == var_name; 
            });
            if( temp.length ) {
                temp[0].texts.push({    readable_date: $(this).attr("readable_date"),
                                        address: $(this).attr("address"),
                                        body: $(this).attr("body"),
                                        date: $(this).attr("date"),
                                        type: parseInt($(this).attr("type"))
                                    });
            }
            else {
                docContents.push(
                    { 
                        name: var_name,
                        texts: [{   
                                    readable_date: $(this).attr("readable_date"),
                                    address: $(this).attr("address"),
                                    body: $(this).attr("body"),
                                    date: $(this).attr("date"),
                                    type: parseInt($(this).attr("type"))
                                }]
                    }                   
                );
            }
        });
        
        // Sort 
        docContents.sort(function(a, b) {
            let checkIfNumber = /^[0-9+]+$/; //正規表現、終始半角数字で1文字以上の文字列を示す
            if ( sent_count(a.texts) < sent_count(b.texts) ) {
                return 1;
            }
            if ( sent_count(a.texts) > sent_count(b.texts) ) {
                return -1;
            }
            if ( checkIfNumber.test(a.name) && ! checkIfNumber.test(b.name) ) {
                return 1;
            }
            if ( ! checkIfNumber.test(a.name) && checkIfNumber.test(b.name) ) {
                return -1;
            }
            if ( a.texts.length - b.texts.length < 0 ) {
                return 1;
            }
            if ( a.texts.length - b.texts.length > 0 ) {
                return -1;
            }
            return parseFloat(b.texts[b.texts.length - 1].date) - parseFloat(a.texts[a.texts.length - 1].date);
        }); 
        
        // Form the group
        var html = '<h3>Text Messages</h3><div class="panel-group" id="accordion">';
        
        /*
        // original
        $.each(docContents, function(personIndex, personObject){
            // Start the group member, label with the name
            var sent_count_value = sent_count(personObject.texts);
            //var sent_count = 0;
            //html += "sent_count = " + sent_count;
            var received_count_value = received_count(personObject.texts);
            //var received_count_value = 0;
            html += '<div class="panel panel-default"><div class="panel-heading">' +
                '<h4 class="panel-title"><a data-target="#collapse' + personIndex + 
                '" data-toggle="collapse" data-parent="#accordion">' +
                personObject.name + ' - ' + personObject.texts.length + ' (S:' +
                sent_count_value + ',R:' + received_count_value + ')' + '</a></h4></div><div id="collapse' + 
                personIndex + '" class="panel-collapse collapse"><div class="panel-body">' + 
                '<table class="table table-bordered table-condensed table-striped" >' + 
                '<tr><th>Date</th><th>Status</th><th>Message</th></tr>';
            
            //Populate the texts
            $.each(personObject.texts, function(textIndex, textObject) {
                var status;
                if (textObject.type == 1) status = "Received";
                else if (textObject.type == 2) status = "Sent";
                else status = "Other";
                
                html += '<tr><td class="messageDateCell">' + textObject.readable_date + 
                '</td><td>' + status + '</td><td>' + textObject.body + '</td></tr>';
            });
            
            //Finish the group member
            html += '<tr><td colspan="3"><a data-target="#collapse' + personIndex + '" data-toggle="collapse" data-parent="#accordion">' +
                'Close</a></td></tr></table></div></div></div>';
        });
        */


        // LINE風CSS
        $.each(docContents, function(personIndex, personObject){
            // Start the group member, label with the name
            var sent_count_value = sent_count(personObject.texts);
            //var sent_count = 0;
            //html += "sent_count = " + sent_count;
            var received_count_value = received_count(personObject.texts);
            //var received_count_value = 0;


            html += '<div class="panel panel-default"><div class="panel-heading">' +
                '<h4 class="panel-title"><a data-target="#collapse' + personIndex + 
                '" data-toggle="collapse" data-parent="#accordion">' +
                personObject.name + ' - ' + personObject.texts.length + ' (S:' +
                sent_count_value + ',R:' + received_count_value + ')' + '</a></h4></div><div id="collapse' + 
                personIndex + '" class="panel-collapse collapse"><div class="panel-body">';

            html += '<div class="room">';
            html += '<ul>';


            //メッセージ
            $.each(personObject.texts, function(textIndex, textObject) {
                var status;
                if (textObject.type == 1) status = "Received";
                else if (textObject.type == 2) status = "Sent";
                else status = "Other";
                
                if (textObject.type == 1) {
                    html += '<li class="chat you">';
                } else {
                    html += '<li class="chat me">';
                }
                html += '<p class="mes">';

                var msg = textObject.body;
                //msg = msg.replace("&#10;", "<br>\n");
                //msg = msg.replace("&#13;", "<br>\n");
                //msg = msg.replace("KAI", "<br>\n");
                msg = msg.replace(/\n/g, "<br>\n");
                console.log("msg="+msg);

                html += msg;
                html += '</p>';
                html += '</li>';
            });


            html += '</ul>';
            html += '</div>';

            html += '</div></div></div></div>';
        });
        
        // Finish the group
        html += '</div>';
        $("#content").html(html);   
        
    }

    $(document).ready(function(){
        $("#xml-file").change(handleFileSelect);
        $( "#accordion" ).accordion({ collapsible: true });
    });
</script>
<input type="file" id="xml-file" name="files" />
<div id="content">
    
</div>
</body>
</html>
