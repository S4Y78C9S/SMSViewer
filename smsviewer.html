<!doctype html>
<html lang='en'>
<head>
    <meta charset='utf-8'>
    <title>SMS Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- jQuery to help make some magic happen -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.14.1/jquery-ui.min.js"></script>

    <!-- Twitter Bootstrap to make it pretty -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>

    <!-- Small UI tweaks -->
    <link rel="stylesheet" type="text/css" href="style.css">

</head>
<body>
<script type="text/javascript">

    function handleFileSelect(evt) {
        var file = evt.target.files[0];
        fr = new FileReader();
        fr.onload = receivedText;
        fr.readAsText(file);
    }       
console.log("debug1<br/>\n");
    function sent_count(arr) {
        var result = 0;
        for ( const elem of arr) {
            if ( elem.type == 2 ) result++;
        }
        return result;
    }
console.log("debug2<br/>\n");
    function received_count(arr) {
        var result = 0;
        for ( const elem of arr) {
            if ( elem.type == 1 ) result++;
        }
        return result;
    }
console.log("debug3<br/>\n");
    function receivedText() { 
        var docContents = new Array();
        var text = fr.result.replace('&#5', '\&\#5');
        $xml = $( $.parseXML( text ) );
        $xml.find("sms").each(function(){
            var var_name = $(this).attr("contact_name");
            if(!var_name || var_name == "(Unknown)") var_name = $(this).attr("address").replace('+1', '');
            var temp = $.grep(docContents, function (e) { 
                return e.name == var_name; 
            });
            if( temp.length ) {
                temp[0].texts.push({    readable_date: $(this).attr("readable_date"),
                                        address: $(this).attr("address"),
                                        body: $(this).attr("body"),
                                        date: $(this).attr("date"),
                                        type: parseInt($(this).attr("type"))
                                    });
            }
            else {
                docContents.push(
                    { 
                        name: var_name,
                        texts: [{   
                                    readable_date: $(this).attr("readable_date"),
                                    address: $(this).attr("address"),
                                    body: $(this).attr("body"),
                                    date: $(this).attr("date"),
                                    type: parseInt($(this).attr("type"))
                                }]
                    }                   
                );
            }
        });
        
        // Sort 
        docContents.sort(function(a, b) {
            let checkIfNumber = /^[0-9+]+$/; //正規表現、終始半角数字で1文字以上の文字列を示す
            if ( sent_count(a.texts) < sent_count(b.texts) ) {
                return 1;
            }
            if ( sent_count(a.texts) > sent_count(b.texts) ) {
                return -1;
            }
            if ( checkIfNumber.test(a.name) && ! checkIfNumber.test(b.name) ) {
                return 1;
            }
            if ( ! checkIfNumber.test(a.name) && checkIfNumber.test(b.name) ) {
                return -1;
            }
            if ( a.texts.length - b.texts.length < 0 ) {
                return 1;
            }
            if ( a.texts.length - b.texts.length > 0 ) {
                return -1;
            }
            return parseFloat(b.texts[b.texts.length - 1].date) - parseFloat(a.texts[a.texts.length - 1].date);
        }); 
        
        // Form the group
        var html = '<h3>Text Messages</h3><div class="panel-group" id="accordion">';
        


        // LINE風CSS
        $.each(docContents, function(personIndex, personObject){
            // Start the group member, label with the name
            var sent_count_value = sent_count(personObject.texts);
            //var sent_count = 0;
            //html += "sent_count = " + sent_count;
            var received_count_value = received_count(personObject.texts);
            //var received_count_value = 0;


            html += '<div class="panel panel-default">';
            html += '<div class="panel-heading">';
            html += '<h4 class="panel-title">';
            html += '<a href="#collapse' + personIndex + 
                '" data-bs-toggle="collapse" data-parent="#accordion">' +
                personObject.name + ' - ' + personObject.texts.length + ' (送:' +
                sent_count_value + ',受:' + received_count_value + ')' + '</a>';
            html += '</h4>';
            html += '</div>'; // panel-heading
            html += '<div id="collapse' + 
                personIndex + '" class="panel-collapse collapse">';
            html += '<div class="panel-body">';

            html += '<div class="room">';
            html += '<ul>';


            //メッセージ
            $.each(personObject.texts, function(textIndex, textObject) {
                var status;
                if (textObject.type == 1) status = "Received";
                else if (textObject.type == 2) status = "Sent";
                else status = "Other";
                
                if (textObject.type == 1) {
                    html += '<li class="chat you">';
                } else {
                    html += '<li class="chat me">';
                }
                html += '<p class="mes">';

                var msg = textObject.body;
                msg = msg.replace(/\n/g, "<br>\n");
                console.log("msg="+msg);

                html += msg;
                html += '</p>';
                html += '<div class="status">';
                html += textObject.readable_date.replace(" ","<br>");
                html += '</div>';
                html += '</li>';
            });


            html += '</ul>';
            html += '</div>'; // room

            html += '</div>'; // panel-body
            html += '</div>'; // collapse
            html += '</div>'; // panel-default
        });
        
        // Finish the group
        html += '</div>';
        $("#content").html(html);   
        
    }

    $(document).ready(function(){
        $("#xml-file").change(handleFileSelect);
        $( "#accordion" ).accordion({ collapsible: true });
    });
</script>
<input type="file" id="xml-file" name="files" />
<div id="content">
    
</div>
</body>
</html>
